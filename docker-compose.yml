services:
  tinyauth:
    image: ghcr.io/steveiliop56/tinyauth:v4
    container_name: tinyauth
    restart: unless-stopped
    environment:
      TINYAUTH_APPURL: "https://auth.example.com"
      TINYAUTH_AUTH_USERSFILE: /users/users.txt
      TINYAUTH_DISABLEANALYTICS: "true"
      TINYAUTH_AUTH_SECURECOOKIE: "true"
      TINYAUTH_UI_FORGOTPASSWORDMESSAGE: '<a href="https://auth.example.com/manage/reset-password">Forgot your password?</a>'
    volumes:
      - ./users:/users
      - ./data:/data
    networks:
      - traefik
    labels:
      traefik.enable: "true"
      traefik.http.routers.tinyauth.rule: Host(`auth.example.com`)
      traefik.http.routers.tinyauth.entrypoints: websecure
      traefik.http.routers.tinyauth.tls.certresolver: letsencrypt
      traefik.http.services.tinyauth.loadbalancer.server.port: "3000"
      traefik.http.middlewares.tinyauth.forwardauth.address: http://tinyauth:3000/api/auth/traefik

  usermanagement:
    image: git.initialize.nl/aivy/tinyauth-usermanagement:latest
    container_name: tinyauth-usermanagement
    restart: unless-stopped
    environment:
      PORT: "8080"
      USERS_FILE_PATH: /users/users.txt
      USERS_TOML: /users/users.toml
      # Single config point â€” derives verify + logout URLs automatically
      TINYAUTH_BASEURL: "http://tinyauth:3000"
      TINYAUTH_CONTAINER_NAME: tinyauth
      DISABLE_SIGNUP: "true"
    volumes:
      - ./users:/users
      - ./config.toml:/data/config.toml
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - traefik
    labels:
      traefik.enable: "true"
      traefik.http.routers.usermanagement.rule: Host(`auth.example.com`) && PathPrefix(`/manage`)
      traefik.http.routers.usermanagement.entrypoints: websecure
      traefik.http.routers.usermanagement.tls.certresolver: letsencrypt
      traefik.http.services.usermanagement.loadbalancer.server.port: "8080"
    depends_on:
      - tinyauth

networks:
  traefik:
    external: true
